import org.yaml.snakeyaml.Yaml;

import java.io.FileInputStream;
import java.io.InputStream;
import java.util.*;

public class EventRoutingConfigUtil {

    public static EventRoutingConfig readyYml() {
        try {
            // Load the entire YAML file into a Map
            Yaml yaml = new Yaml();
            InputStream inputStream = new FileInputStream("src/test/resources/application-test.yml");
            Map<String, Object> yamlMap = yaml.load(inputStream);

            // Initialize EventRoutingConfig
            EventRoutingConfig config = new EventRoutingConfig();

            // Extract and set 'origins'
            config.setOrigins(castToMapOfStringString(((Map<String, Object>) yamlMap.get("event-routing")).get("origins")));

            // Extract and set 'destination-routingKey-map'
            config.setDestinationRoutingKeyMap(castToDestinationMap(((Map<String, Object>) yamlMap.get("event-routing")).get("destination-routingKey-map")));

            // Extract and set 'destinationCopybookToRoutingMap'
            config.setDestinationCopybookToRoutingMap(castToMapOfStringString(((Map<String, Object>) yamlMap.get("event-routing")).get("destination-copybook-to-routing-map")));

            // Extract and set 'originPopulateCopybook'
            config.setOriginPopulateCopybook(castToMapOfStringList(((Map<String, Object>) yamlMap.get("event-routing")).get("originPopulateCopybook")));

            // Extract and set 'filterCopybookByPublisher'
            config.setFilterCopybookByPublisher(castToMapOfStringSet(((Map<String, Object>) yamlMap.get("event-routing")).get("filter-copybook-by-publisher")));

            // Debug output to verify the extracted data
            System.out.println("Loaded Event Routing Config: " + config);

            return config;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    // Utility method to cast objects to Map<String, String>
    private static Map<String, String> castToMapOfStringString(Object obj) {
        if (obj instanceof Map) {
            return (Map<String, String>) obj;
        }
        return Collections.emptyMap();
    }

    // Utility method to cast objects to Map<String, List<Destination>>
    private static Map<String, List<Destination>> castToDestinationMap(Object obj) {
        Map<String, List<Destination>> destinationMap = new HashMap<>();
        if (obj instanceof Map) {
            Map<String, List<Map<String, Object>>> rawMap = (Map<String, List<Map<String, Object>>>) obj;
            for (String key : rawMap.keySet()) {
                List<Destination> destinations = new ArrayList<>();
                for (Map<String, Object> rawDestination : rawMap.get(key)) {
                    Destination destination = new Destination();
                    destination.setType(DestinationType.valueOf((String) rawDestination.get("type")));
                    destination.setName((String) rawDestination.get("name"));
                    destination.setEnabled((Boolean) rawDestination.get("enabled"));

                    // Handle additional headers
                    if (rawDestination.containsKey("additional-headers")) {
                        List<Map<String, String>> rawHeaders = (List<Map<String, String>>) rawDestination.get("additional-headers");
                        List<HeaderDetails> headers = new ArrayList<>();
                        for (Map<String, String> rawHeader : rawHeaders) {
                            HeaderDetails header = new HeaderDetails();
                            header.setHeaderName(rawHeader.get("header-name"));
                            header.setHeaderPath(rawHeader.get("header-path"));
                            headers.add(header);
                        }
                        destination.setAdditionalHeaders(headers);
                    }
                    destinations.add(destination);
                }
                destinationMap.put(key, destinations);
            }
        }
        return destinationMap;
    }

    // Utility method to cast objects to Map<String, List<String>>
    private static Map<String, List<String>> castToMapOfStringList(Object obj) {
        if (obj instanceof Map) {
            return (Map<String, List<String>>) obj;
        }
        return Collections.emptyMap();
    }

    // Utility method to cast objects to Map<String, Set<String>>
    private static Map<String, Set<String>> castToMapOfStringSet(Object obj) {
        if (obj instanceof Map) {
            Map<String, List<String>> rawMap = (Map<String, List<String>>) obj;
            Map<String, Set<String>> resultMap = new HashMap<>();
            for (String key : rawMap.keySet()) {
                resultMap.put(key, new HashSet<>(rawMap.get(key)));
            }
            return resultMap;
        }
        return Collections.emptyMap();
    }
}